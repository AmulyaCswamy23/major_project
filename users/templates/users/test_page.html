{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduWeb Test Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand:#4a90e2;
      --ok:#28a745;
      --warn:#f39c12;
      --bg:#f4f7fa;
      --card:#fff;
      --text:#222;
      --muted:#666;
    }
    * { box-sizing: border-box; }
    body {
      background:var(--bg);
      font-family: system-ui,-apple-system, Segoe UI, Roboto, Poppins, sans-serif;
      margin:0;
      color:var(--text);
    }
    .header {
      background:var(--brand);
      color:#fff;
      padding:14px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .wrap {
      max-width:1100px;
      margin:24px auto;
      display:grid;
      grid-template-columns: 3fr 1fr;
      gap:20px;
      padding:0 12px;
    }
    .card {
      background:var(--card);
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      padding:20px;
    }
    .progress-bar {
      height:8px;
      background:#e0e0e0;
      border-radius:6px;
      overflow:hidden;
      margin-bottom:16px;
    }
    .progress {
      height:100%;
      width:0%;
      background:var(--brand);
      transition:width .3s ease;
    }
    .qtext {
      margin:12px 0 8px;
      font-weight:600;
      line-height:1.4;
    }
    .opt {
      background:#f9f9f9;
      border-radius:10px;
      padding:10px;
      margin:8px 0;
      cursor:pointer;
      border:1px solid transparent;
    }
    .opt:hover { background:#eef5ff; border-color:var(--brand); }
    .opt label {
      display:flex;
      align-items:flex-start;
      gap:10px;
      width:100%;
      cursor:pointer;
    }
    .opt input[type="radio"] { margin-top:2px; flex:0 0 auto; }
    .opt .opt-text {
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.35;
      display:block;
    }
    .row {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .btn {
      background:var(--brand);
      color:#fff;
      border:0;
      border-radius:8px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .btn.alt { background:var(--ok); }
    .btn.warn { background:var(--warn); }
    .btn.ghost { background:#efefef; color:#333; }
    .grid {
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
    }
    .grid button {
      height:38px;
      border:0;
      border-radius:8px;
      background:#ddd;
      font-weight:700;
      cursor:pointer;
    }
    .grid button.active { background:var(--brand); color:#fff; }
    .grid button.answered { background:var(--ok); color:#fff; }
    .hint {
      display:none;
      background:#fff8e1;
      border-left:5px solid var(--warn);
      padding:12px;
      border-radius:8px;
      margin-top:10px;
    }
    .pill {
      background:#fff;
      color:#333;
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:14px;
    }
    .pill-select {
      border-radius:999px;
      border:none;
      padding:6px 10px;
      font-weight:600;
      font-size:14px;
      font-family:inherit;
      outline:none;
      cursor:pointer;
    }
    .footer {
      text-align:center;
      padding:18px;
      color:#777;
      font-size:14px;
    }
    .hidden { display:none !important; }
    @media (max-width: 920px) {
      .wrap { grid-template-columns: 1fr; }
      .header-right { flex-wrap: wrap; gap:8px; justify-content: flex-end; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div style="font-size:18px; font-weight:700;">üß† EduWeb Test Platform</div>
    <div class="header-right" style="display:flex; gap:12px; align-items:center;">
      <span id="user-pill" class="pill">User: Loading‚Ä¶</span>

      <!-- üîΩ Language selector: user can choose any language -->
      <select id="lang-select" class="pill-select">
        <option value="python" {% if language == "python" %}selected{% endif %}>Python</option>
        <option value="java" {% if language == "java" %}selected{% endif %}>Java</option>
        <option value="cpp" {% if language == "cpp" %}selected{% endif %}>C++</option>
        <option value-"c" {% if language == "c" %}selected{% endif %}>C</option>
      </select>

      <span id="ctx-pill" class="pill">
        Lang: {{language}} | Level: {{difficulty}}
      </span>
      <span id="timer-pill" class="pill">Time Left: 10:00</span>

      <!-- Logout button -->
      <form method="post" action="{% url 'logout' %}" style="margin:0;">
        {% csrf_token %}
        <button type="submit" class="btn ghost" style="padding:6px 12px; font-size:14px;">
          Logout
        </button>
      </form>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="progress-bar"><div id="progress" class="progress"></div></div>

      <div class="row">
        <button id="start-btn" class="btn" type="button">Start Test</button>
      </div>

      <div id="status" style="margin-top:10px; color:#666;"></div>

      <div id="qbox" style="margin-top:16px;">
        <div id="qnum" style="font-weight:700;"></div>
        <div id="qtext" class="qtext">No question loaded yet.</div>
        <div id="opts"></div>

        <div id="hint" class="hint" aria-live="polite"></div>

        <div class="row">
          <button id="hint-btn" class="btn warn" type="button">üí° Hint</button>
          <div>
            <button id="prev-btn" class="btn" type="button" disabled>Previous</button>
            <button id="next-btn" class="btn" type="button">Next</button>
            <button id="submit-btn" class="btn alt hidden" type="button">Submit</button>
          </div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0;">Question Tracker</h3>
        <span id="hints-pill" class="pill">Hints: 0</span>
      </div>
      <div id="tracker" class="grid"></div>
    </aside>
  </main>

  <div class="footer">¬© EduWeb</div>

<script>
/* ---------- config (Django template vars) ---------- */
/* We treat these as initial suggestions from backend */
let currentLang = "{{language}}";
let currentLevel = "{{difficulty}}";   // RL / rules may set this
// When user changes language from dropdown, we force currentLevel = "Beginner"

const MCQ_API = "/api/questions/";
const HINT_API = "/api/hint/";
const SAVE_API = "/api/submit_test/";
const USER_API = "/api/user";

const TOTAL_SECONDS = 10 * 60;
const CAN_TAKE = Boolean(Number("{{ can_take|yesno:'1,0' }}")); // from start_test_page view

/* ---------- state ---------- */
let questions = [];
let idx = 0;
let answers = {};
let hintsUsed = 0;
let timer = null;
let remaining = TOTAL_SECONDS;

/* ---------- DOM helpers ---------- */
function $(id){ return document.getElementById(id); }
function setStatus(msg, type="info"){
  $("status").style.color = (type==="error" ? "#c0392b" : "#666");
  $("status").textContent = msg || "";
}

/* ---------- user pill ---------- */
async function loadUser(){
  try{
    const r = await fetch(USER_API, { credentials: "include" });
    const data = await r.json();
    $("user-pill").textContent = `User: ${data.username || "‚Äî"}`;
  } catch {
    $("user-pill").textContent = "User: ‚Äî";
  }
}

/* ---------- timer ---------- */
function startTimer(){
  clearInterval(timer);
  remaining = TOTAL_SECONDS;
  tick();
  timer = setInterval(tick,1000);
}
function tick(){
  if(remaining <= 0){
    clearInterval(timer);
    $("timer-pill").textContent = "Time Left: 00:00";
    setStatus("‚õî Time's up ‚Äî auto-submitting...");
    submitNow();
    return;
  }
  remaining--;
  const m = String(Math.floor(remaining/60)).padStart(2,"0");
  const s = String(remaining % 60).padStart(2,"0");
  $("timer-pill").textContent = `Time Left: ${m}:${s}`;
}

/* ---------- question helpers ---------- */
function normalizeQ(q){
  return {
    q: String(q.question ?? q.q ?? ""),
    options: Array.isArray(q.options) ? q.options.slice(0,4) : [],
    answer: String(q.answer ?? "")
  };
}

function renderQuestion(i){
  if(!questions[i]) return;
  const q = normalizeQ(questions[i]);
  $("qnum").textContent = `Question ${i+1} of ${questions.length}`;
  $("qtext").textContent = q.q;

  $("hint").style.display = "none";
  $("hint").textContent = "";

  const opts = $("opts");
  opts.innerHTML = "";

  q.options.forEach((opt,k)=>{
    const id = `q_${i}_${k}`;
    const row = document.createElement("div");
    row.className = "opt";
    row.innerHTML = `
      <label for="${id}">
        <input type="radio" name="q_${i}" id="${id}" value="${opt}">
        <span class="opt-text">${opt}</span>
      </label>
    `;
    const input = row.querySelector("input");
    if(answers[i] === opt) input.checked = true;
    input.addEventListener("change", ()=>{
      answers[i] = opt;
      updateTracker();
    });
    opts.appendChild(row);
  });

  $("prev-btn").disabled = i === 0;
  $("next-btn").classList.toggle("hidden", i === questions.length - 1);
  $("submit-btn").classList.toggle("hidden", i !== questions.length - 1);

  updateProgress();
  updateTracker();
}

function updateProgress(){
  const pct = questions.length ? ((idx+1)/questions.length)*100 : 0;
  $("progress").style.width = `${pct}%`;
}

function buildTracker(){
  const t = $("tracker");
  t.innerHTML = "";
  for(let i=0;i<questions.length;i++){
    const btn = document.createElement("button");
    btn.textContent = i+1;
    btn.addEventListener("click", ()=>{
      idx = i;
      renderQuestion(idx);
    });
    t.appendChild(btn);
  }
  updateTracker();
}

function updateTracker(){
  const btns = $("tracker").querySelectorAll("button");
  btns.forEach((b,i)=>{
    b.classList.toggle("active", i===idx);
    b.classList.toggle("answered", !!answers[i]);
  });
}

/* ---------- network helpers ---------- */
function getCSRF(){
  const m = document.cookie.match(/csrftoken=([^;]+)/);
  return m ? m[1] : "";
}

async function fetchMCQs(){
  const url = `${MCQ_API}?lang=${encodeURIComponent(currentLang)}&level=${encodeURIComponent(currentLevel)}`;
  const res = await fetch(url, { credentials: "include" });
  if(!res.ok) throw new Error("Failed to fetch questions");
  const data = await res.json();
  return data.map(normalizeQ);
}

/* ---------- events ---------- */
$("start-btn").addEventListener("click", async ()=>{
  if (!CAN_TAKE) {
    setStatus("You have already taken today's test. Please come back tomorrow.", "error");
    return;
  }

  setStatus("");
  answers = {};
  hintsUsed = 0;
  $("hints-pill").textContent = `Hints: ${hintsUsed}`;

  try{
    questions = await fetchMCQs();
  } catch(e){
    console.error(e);
    setStatus("‚ùå Failed to load questions.", "error");
    return;
  }

  if(!questions.length){
    setStatus("‚ùå No questions received.", "error");
    return;
  }

  idx = 0;
  buildTracker();
  renderQuestion(idx);
  startTimer();
  setStatus("‚úÖ Questions loaded!");
});

$("prev-btn").addEventListener("click", ()=>{
  if(idx>0){
    idx--;
    renderQuestion(idx);
  }
});

$("next-btn").addEventListener("click", ()=>{
  if(idx < questions.length - 1){
    idx++;
    renderQuestion(idx);
  }
});

$("hint-btn").addEventListener("click", async ()=>{
  if(!questions[idx]) return;
  const qtext = normalizeQ(questions[idx]).q;
  $("hint").style.display = "block";
  $("hint").textContent = "Loading hint‚Ä¶";
  try{
    const r = await fetch(HINT_API, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRF() },
      credentials: "include",
      body: JSON.stringify({ question: qtext })
    });
    const resjson = await r.json();
    $("hint").textContent = "üí° " + (resjson.hint || "Think about edge cases.");
    hintsUsed++;
    $("hints-pill").textContent = `Hints: ${hintsUsed}`;
    setTimeout(()=> $("hint").style.display = "none", 9000);
  }catch(err){
    console.error(err);
    $("hint").textContent = "Hint service unavailable.";
    setTimeout(()=> $("hint").style.display = "none", 5000);
  }
});

/* ---------- language selector: force Beginner when changing lang ---------- */
const langSelect = $("lang-select");
if (langSelect) {
  langSelect.addEventListener("change", (e) => {
    currentLang = e.target.value || "python";
    currentLevel = "Beginner";  // üîë whenever user switches language, start from Beginner
    $("ctx-pill").textContent = `Lang: ${currentLang} | Level: ${currentLevel}`;
    setStatus("Language changed. Start a new test to load questions for this language.");
    // If you want: clear existing questions & tracker when language changes
    questions = [];
    answers = {};
    $("qnum").textContent = "";
    $("qtext").textContent = "No question loaded yet.";
    $("opts").innerHTML = "";
    $("tracker").innerHTML = "";
    $("progress").style.width = "0%";
    clearInterval(timer);
    $("timer-pill").textContent = "Time Left: 10:00";
  });
}

/* ---------- submit logic ---------- */
async function submitNow(){
  clearInterval(timer);

  if(!questions.length){
    setStatus("Nothing to submit.", "error");
    return;
  }

  // calculate score
  let correct = 0;
  questions.forEach((q,i)=>{
    const picked = answers[i] || "";
    let gold = q.answer || "";

    const gu = (gold || "").toUpperCase();
    if(["A","B","C","D"].includes(gu) && Array.isArray(q.options) && q.options.length >= 4){
      const idxMap = { A:0, B:1, C:2, D:3 };
      gold = q.options[idxMap[gu]];
    }

    if(picked === gold) correct++;
  });

  const total = questions.length;
  const score = Math.round((correct/total)*100);
  const timeTaken = TOTAL_SECONDS - remaining;

  const payload = {
    language: currentLang,
    difficulty: currentLevel,
    score: score,
    hints_used: hintsUsed,
    time_taken: timeTaken
  };

  try{
    const r = await fetch(SAVE_API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRF()
      },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    // hard lock from backend (already took test today)
    if (r.status === 403) {
      let data = {};
      try { data = await r.json(); } catch {}
      alert(data.message || "You have already taken today's test. Please come back tomorrow.");
      window.location.href = "/dashboard/";
      return;
    }

    if(!r.ok){
      const text = await r.text();
      console.error("submit error response:", r.status, text);
      setStatus("‚ùå Failed to save result (server error).", "error");
      return;
    }

    const result = await r.json();

    const nextLang = result.next_language || "";
    const nextLvl  = result.next_level || "";
    const canChoose = !!result.can_choose_next_language;
    const repeatLevel = !!result.repeat_level;
    const revisionTopics = result.revision_topics || [];

    const params = new URLSearchParams({
      score: String(score),
      correct: String(correct),
      total: String(total),
      hints: String(hintsUsed),
      time: String(timeTaken),
      language: String(currentLang),
      difficulty: String(currentLevel),
      next_language: String(nextLang),
      next_level: String(nextLvl),
      can_choose_next_language: canChoose ? "true" : "false",
    });

    if (repeatLevel && revisionTopics.length) {
      params.set("topics", JSON.stringify(revisionTopics));
    }

    window.location.href = "/test-result/?" + params.toString();

  } catch(err){
    console.error("submit exception:", err);
    setStatus("‚ùå Network or server error while saving result.", "error");
  }
}

$("submit-btn").addEventListener("click", submitNow);

/* ---------- init ---------- */
loadUser();
if (!CAN_TAKE) {
  $("start-btn").disabled = true;
  setStatus("You have already taken today's test. Please come back tomorrow.");
}
</script>
</body>
</html>